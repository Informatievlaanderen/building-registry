namespace BuildingRegistry.Tests
{
    using Be.Vlaanderen.Basisregisters.Utilities.HexByteConvertor;
    using BuildingRegistry.Legacy;
    using FluentAssertions;
    using NetTopologySuite.Geometries;
    using NetTopologySuite.Geometries.Utilities;
    using Xunit;

    public class PolygonTests
    {
        private readonly Geometry? _polygonSelfTouchingRingFormingHoles;

        public PolygonTests()
        {
            _polygonSelfTouchingRingFormingHoles = WKBReaderFactory.Create().Read(
                "0103000000020000001900000000F40D5303BBEF400057C7CECA67044100C477694BBBEF40806D4A56D467044100701B1455BBEF408081A8D8CF67044100CCDDB50CBBEF408004D824C6670441004053B650BBEF40007FB4DCA86704410094111E95BBEF40003E8A17B267044100C836B0DDBBEF408003885F906704410044AF46FEBBEF400006AF3A81670441009432B056BCEF40803090448E6704410080367952BCEF40007AD6129167044100742CF63FBCEF40008C7A659D67044100842D28D4BFEF408072A1CF1668044100101BDED4BFEF408076BFE71668044100889110EDBFEF4000DFA61C1A680441003C337389BFEF40800801D64968044100902690DABEEF400066E39E9D680441001006A530BBEF4000C45D9A2168044100AC2CD84EBBEF4080FE258613680441000443EBE9B8EF4080B25A3DC667044100F0454970B9EF40806B1AB88267044100A8579886BAEF4080787054A567044100BC857CB8BAEF400014C588AB6704410078EFAF26BBEF40008F2C3DB967044100CCDDB50CBBEF408004D824C667044100F40D5303BBEF400057C7CECA670441070000000078DCF7F0BBEF4080FEA82A936704410030432320BCEF4080EE4F86996704410090EF9220BCEF400057A63C9967044100E876362CBCEF4000BDB99C91670441005CCF1703BCEF4080C04D238C6704410074D36DF1BBEF40009B2DFD926704410078DCF7F0BBEF4080FEA82A93670441"
                    .ToByteArray());
        }

        [Fact]
        public void GivenPolygonWithSelfTouchingRingFormingHoles_ThenNTSPolygonIsNotValid()
        {
            var polygon = _polygonSelfTouchingRingFormingHoles as Polygon;

            polygon.IsValid.Should().BeFalse();
        }

        [Fact]
        public void GivenPolygonWithSelfTouchingRingFormingHoles_ThenGrbPolygonIsValid()
        {
            var polygon = _polygonSelfTouchingRingFormingHoles as Polygon;
            var grbPolygon = new GrbPolygon(polygon);

            grbPolygon.IsValid.Should().BeTrue();
        }

        /// <summary>
        /// DATE: 10/02/2023 (polygon could be changed afterwards)
        /// https://api.basisregisters.vlaanderen.be/v1/gebouwen/15078651
        /// CrabTerreinObjectId = 15885663
        /// GrbOIDN = 3267099
        /// Question client:
        /// Nu hebben we in onze backend een validatie regel staan die zorgt dat we geen geometriën bewaren die niet aan de 'validity' specificaties voldoen.
        /// We hadden dit toegevoegd omdat gebruikers ook zelf constructies kunnen tekenen en dus de meest gekke dingen produceerden.
        /// Deze validatie zorgde echter een paar weken geleden tot een melding van een deskundige die aangaf dat hij de constructie op [REDACTED] in Aalter niet kon selecteren als gebouw om te inspecteren.
        /// See summary <see cref="GrbPolygon"/> and <see cref="GeometryValidator"/>
        ///
        /// https://extendsclass.com/postgresql-online.html (activate postgis)
        /// SELECT ST_IsValid(ST_GeomFromText('POLYGON ((88217.87126454711 202474.59182255715, 88217.60553655028 202478.65607855842, 88216.6367045492 202478.58708655834, 88216.48092854768 202481.28110256046, 88217.99772854894 202481.3942545615, 88218.12892854959 202479.2544785589, 88220.10358455032 202479.48769456148, 88220.49808055162 202475.23707055673, 88221.08668854833 202474.92027055845, 88223.22934455425 202473.7673745565, 88223.44188855588 202474.23297455534, 88226.39312055707 202480.6986385621, 88224.13513655216 202481.9986705631, 88228.80796855688 202489.0985105671, 88218.6029125452 202495.68487857282, 88213.99164854735 202488.5125905685, 88215.33577654511 202487.6451345645, 88213.6817605421 202485.082318563, 88212.22467254102 202477.61620656028, 88211.65968054533 202474.72155055776, 88212.42313654721 202474.58747055754, 88212.5248965472 202473.03419055417, 88212.55350454152 202472.5975825563, 88213.05283254385 202464.97806255147, 88217.87894454598 202463.85780654848, 88218.69737654924 202463.66785455123, 88221.64656054974 202462.98331055045, 88221.40323255211 202468.17191855237, 88221.32048054785 202469.9359505549, 88221.08668854833 202474.92027055845, 88217.87126454711 202474.59182255715))', 31370));
        /// Returns Valid = false
        ///
        /// In MsSql
        /// declare @g geometry
        /// SET @g = geometry::STGeomFromText('POLYGON ((88217.87126454711 202474.59182255715, 88217.60553655028 202478.65607855842, 88216.6367045492 202478.58708655834, 88216.48092854768 202481.28110256046, 88217.99772854894 202481.3942545615, 88218.12892854959 202479.2544785589, 88220.10358455032 202479.48769456148, 88220.49808055162 202475.23707055673, 88221.08668854833 202474.92027055845, 88223.22934455425 202473.7673745565, 88223.44188855588 202474.23297455534, 88226.39312055707 202480.6986385621, 88224.13513655216 202481.9986705631, 88228.80796855688 202489.0985105671, 88218.6029125452 202495.68487857282, 88213.99164854735 202488.5125905685, 88215.33577654511 202487.6451345645, 88213.6817605421 202485.082318563, 88212.22467254102 202477.61620656028, 88211.65968054533 202474.72155055776, 88212.42313654721 202474.58747055754, 88212.5248965472 202473.03419055417, 88212.55350454152 202472.5975825563, 88213.05283254385 202464.97806255147, 88217.87894454598 202463.85780654848, 88218.69737654924 202463.66785455123, 88221.64656054974 202462.98331055045, 88221.40323255211 202468.17191855237, 88221.32048054785 202469.9359505549, 88221.08668854833 202474.92027055845, 88217.87126454711 202474.59182255715))', 31370);
        /// select @g.STIsValid()
        /// Returns Valid = true
        ///
        /// More info about MsSql validity:
        /// https://gis.stackexchange.com/questions/410721/can-a-self-intersecting-banana-polygon-be-made-ogc-compliant-in-an-azure-sql-dat
        /// </summary>
        [Fact]
        public void GivenGrarBuilding15078651()
        {
            var extendedWkbGeometry = new ExtendedWkbGeometry("01030000208A7A0000010000001F0000000018B3F09D89F54000770DBC54B70841001847B09989F540801DA63F75B70841001CF12F8A89F54000705AB274B708410022E2B18789F54000B3B23F8AB708410036B2F69F89F54080EF6E278BB7084100621710A289F540000E2C097AB70841004648A8C189F5400068CCE67BB70841005023F8C789F540803F85E559B7084100881363D189F54080CFB65C57B70841003265ABF389F540804595234EB7084100BCF911F789F54080C321DD51B7084100C8384A268AF54080D0CF9685B7084100F28429028AF54000FE46FD8FB70841007070ED4C8AF54080E8BFC9C8B7084100A087A5A989F540009EA17AFDB7084100DECADD5F89F5408015C919C4B70841003A575F7589F540804F3C29BDB7084100BE7DE85A89F54080A296A8A8B70841003C42984389F54080B4FDED6CB7084100300D8E3A89F540804CBCC555B7084100D42AC54689F54080C323B354B7084100ECF9654889F54080B2054648B70841009427DB4889F540005DD9C744B7084100F066D85089F540807512D307B70841002828109E89F54000AEC9DCFEB6084100507428AB89F5408020C457FDB6084100E04F58DA89F54000ECD1DDF7B6084100FAA373D689F54080D5166021B708410036B020D589F54000A5D37C2FB7084100881363D189F54080CFB65C57B708410018B3F09D89F54000770DBC54B70841".ToByteArray());

            var polygonSelfTouchingRingFormingHoles = extendedWkbGeometry.ToGeometry();

            var polygon = polygonSelfTouchingRingFormingHoles as Polygon;
            var grbPolygon = new GrbPolygon(polygon);

            polygon.IsValid.Should().BeFalse();
            grbPolygon.IsValid.Should().BeTrue();


        }

        /// <summary>
        /// DATE: 1/10/2025 (polygon could be changed afterwards)
        /// https://api.basisregisters.vlaanderen.be/v2/gebouwen/31912514
        ///
        /// Claim from GRB that this polygon is invalid, but MS SQL + NTS says it's valid.
        ///
        /// select geometry::STGeomFromText('POLYGON ((76334.58333778383 169985.72249904636, 76337.76829408009 169985.05009705175,  76336.27953694883 169977.99832380182,  76331.71906681615 169978.96112169552,  76332.89316427232 169984.52245125046,  76334.94298703629 169985.64657057129,  76334.58333778383 169985.72249904636))', '31370').STIsValid()
        /// select geometry::STGeomFromText('POLYGON ((76334.58333778383 169985.72249904636, 76337.76829408009 169985.05009705175,  76336.27953694883 169977.99832380182,  76331.71906681615 169978.96112169552,  76332.89316427232 169984.52245125046,  76334.94298703629 169985.64657057129,  76334.58333778383 169985.72249904636))', '31370').IsValidDetailed()
        /// Both return 1 (true) / Valid
        ///
        /// AI Feedback:
        /// I re-checked the coordinates carefully:
        /// (1) 76334.58333778383 169985.72249904636
        /// (2) 76337.76829408009 169985.05009705175
        /// (3) 76336.27953694883 169977.99832380182
        /// (4) 76331.71906681615 169978.96112169552
        /// (5) 76332.89316427232 169984.52245125046
        /// (6) 76334.94298703629 169985.64657057129
        /// (1) 76334.58333778383 169985.72249904636 (closed)
        ///
        /// If you check all non-adjacent segment pairs, none of them actually cross. What does happen is:
        ///
        ///  - Point (6) lies on the straight line between points (1) and (2) — it’s an extra vertex on an otherwise straight edge.
        ///  - That’s a collinear extra vertex, not a self-intersection (no “bow-tie” / figure-8).
        ///
        /// This is perfectly fine for a polygon boundary: it just has a redundant vertex along an edge. In OGC / NetTopologySuite terms:
        ///
        ///   - The ring is closed.
        ///   - The area is non-zero.
        ///   - The edges do not intersect each other except at shared endpoints.
        ///   - So the polygon is valid and simple, which is why IsValid returns true.
        ///
        /// So: ✅ NetTopologySuite is right, ❌ my earlier “self-intersecting bow-tie” claim was incorrect — thanks for catching that.
        ///
        /// More feedback and issue: https://vlaamseoverheid.atlassian.net/browse/GAWR-7149
        /// </summary>
        [Fact]
        public void GivenSelfIntersectsReportedPolygon31912514()
        {
            // It's NOT self-intersecting, see explanation in summary
            // But it's been reported as such
            var wkt = @"POLYGON ((
  76334.58333778383 169985.72249904636,
  76337.76829408009 169985.05009705175,
  76336.27953694883 169977.99832380182,
  76331.71906681615 169978.96112169552,
  76332.89316427232 169984.52245125046,
  76334.94298703629 169985.64657057129,
  76334.58333778383 169985.72249904636
))";
            var geometry = GeometryHelper.CreateGeometryFromWkt(wkt);
            GeometryValidator.IsValid(geometry).Should().BeTrue();

            GeometryFixer.Fix(geometry);
            geometry.AsText().Split(",").Length.Should().Be(7); // still 7 points, no change
        }
    }
}
